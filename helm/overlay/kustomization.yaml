apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
# import the default deployment as the base
bases:
  - ../../operator/config/default
  - ../../klt-cert-manager/config/default
  - ../../scheduler/manifests/install
# replace the default namespace with {{ include "chart.namespace" . }}
# .Release.Namespace has not been used so that a custom _helpers.tpl file can maintain the expected behaviour of
# helm install -n
namespace: "{{ .Release.Namespace }}"
patchesStrategicMerge:
  - patches/patch_deployment.yaml

patches:
  - patch: |
      - op: replace
        path: '/spec/template/spec/containers/0/imagePullPolicy'
        value: |-
          {{ .Values.global.imagePullPolicy}}
    target:
      kind: Deployment
      name: "(controller-manager|cert-manager|keptn-scheduler)"
  - patch: |
      - op: add
        path: '/spec/template/metadata'
        value: |
          {{- if or .Values.podLabels .Values.commonLabels }}
          labels:
            {{- if .Values.commonLabels }}
            {{- include "common.tplvalues.render" ( dict "value" .Values.commonLabels "context" $ ) | nindent 8 }}
            {{- end }}
            {{- if .Values.podLabels }}
            {{- include "common.tplvalues.render" ( dict "value" .Values.podLabels "context" $) | nindent 8 }}
            {{- end }}
          {{- end }}
          {{- if or .Values.podAnnotations .Values.commonAnnotations }}
          annotations:
            {{- if .Values.commonAnnotations }}
              {{- include "common.tplvalues.render" ( dict "value" .Values.commonAnnotations "context" $ ) | nindent 8 }}
            {{- end }}
            {{- if .Values.podAnnotations }}
              {{- include "common.tplvalues.render" ( dict "value" .Values.podAnnotations "context" $) | nindent 8 }}
            {{- end }}
          {{- end }}
    target:
      kind: Deployment
      name: "(controller-manager|cert-manager|keptn-scheduler)"